<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="./jquery.facedetection.min.js"></script>
</head>

<body>
<!--<video id="video" autoplay playsinline style="display:none"></video>-->
<!--<video id="video" autoplay playsinline></video>-->
<video id="video" autoplay playsinline style="-webkit-transform: scaleX(-1);"></video>

<!--<canvas id="canvas"></canvas>-->

<hr>
[debug  log]

<p>
<textarea id="mydebug" rows="20" cols="80"></textarea>
</p>

<script>
var debugmsg = "";

function mydebug(data){
    debugmsg+=data+"\n";
    $("#mydebug").text(debugmsg);         
}
</script>

<style>
#video {
  display: block;
  _width: 100%;
}

.face {
  border: 2px solid #FFF;
}
</style>
<script type="text/javascript">
  video = document.getElementById("video");
  video.width = $(window).width();

  var image = new Image();
  image.src = "./GunFace.transparent.png";

  navigator.mediaDevices.getUserMedia( { audio: false, video: { frameRate: { ideal: 2, max: 5 } } } )
  .then( 
    function(stream) {
//      video.src = window.URL.createObjectURL(stream);
      video.srcObject = stream;
    }
  );

  var widthRatio;
  video.addEventListener("loadedmetadata",
    function(e) {
//      setInterval(detection, 200 );

      widthRatio = video.width / video.videoWidth;

      (function animation() {
        detection();
        requestAnimationFrame(animation);
      })();

    }
  );


  function detection() {
    $("#video").faceDetection({
      complete: function (faces) {
try {
//        console.log(faces);
        $('.face').remove();
        for (var i = 0, l = faces.length; i < l; i++) {

//              image.style.cssText = 
//                 "position:absolute;"
//                +"left:"+ (faces[i].x - (faces[i].width  * 0.55)) +"px;"
//                +"top:" + (faces[i].y - (faces[i].height * 0.4)) +"px;"
//                +"width:"+ (faces[i].width  * 2.25 ) +"px;"
//                +"heigh:"+ (faces[i].height * 2.25 ) +"px";

faces[i].x *= widthRatio;
faces[i].y *= widthRatio;
faces[i].width *= widthRatio;
faces[i].height *= widthRatio;


              image.style.cssText = 
                 "position:absolute;"
                +"left:"+ (video.width - (faces[i].width * 2.25) - (faces[i].x - (faces[i].width  * 0.68))) +"px;"
                +"top:" + (faces[i].y - (faces[i].height * 0.4)) +"px;"
                +"width:"+ (faces[i].width  * 2.25 ) +"px;"
                +"heigh:"+ (faces[i].height * 2.25 ) +"px";


              document.body.appendChild(image);


//          $('<div>', {
//            'class':'face',
//            'css': {
//              'position': 'absolute',
//              'left':     faces[i].x + 'px',
//              'top':      faces[i].y + 'px',
//              'width':    faces[i].width  + 'px',
//              'height':   faces[i].height + 'px'
//            }
//          })
//          .insertAfter(video);
        }

} catch (e) {
mydebug(e);
}
      },
      error: function (code, message) {
        alert('Error: ' + message);
      }
    });
  }

</script>
</body>
</html>
